@page "/work-orders"
@layout AuthLayout
@attribute [Authorize]

@using CodeBlue.Data
@using CodeBlue.Data.Entities
@using Microsoft.EntityFrameworkCore
@using MudBlazor

@inject IDbContextFactory<AppDbContext> DbFactory
@inject NavigationManager Nav

<PageTitle>Work Orders</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Class="page-gutters">

    <MudPaper Elevation="1" Class="action-card list-card">

        <MudText Class="cb-page-title mb-2">Work Orders</MudText>

        <MudTextField T="string"
                      @bind-Value="_search"
                      Placeholder="Search (Address / Description / Status)"
                      Adornment="Adornment.Start"
                      AdornmentIcon="@Icons.Material.Filled.Search"
                      Immediate="true"
                      DebounceInterval="250"
                      OnDebounceIntervalElapsed="Reload"
                      FullWidth="true"
                      Class="mb-3" />

        <div class="table-scroll">

            <MudTable T="WorkOrder"
                      Dense="true"
                      Hover="true"
                      Breakpoint="Breakpoint.None"
                      ServerData="LoadWorkOrders"
                      @ref="_table"
                      RowsPerPage="25">

                <HeaderContent>
                    <MudTh Class="col-action"></MudTh>
                    <MudTh Class="col-address">Service Address</MudTh>
                    <MudTh>Scheduled Date</MudTh>
                    <MudTh>Description</MudTh>
                </HeaderContent>

                <RowTemplate>
                    <MudTd Class="col-action">
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       OnClick="@(() => Nav.NavigateTo($"/work-orders/{context.Id}"))"
                                       AriaLabel="View work order" />
                    </MudTd>

                    <MudTd Class="col-address clamp-2">
                        @context.ServiceAddress
                    </MudTd>

                    <MudTd>
                        @context.ScheduledServiceDate?.ToString("MM/dd/yyyy")
                    </MudTd>

                    <MudTd Class="clamp-2">
                        @context.ServiceDetails
                    </MudTd>
                </RowTemplate>

                <NoRecordsContent>
                    <MudText Class="pa-4">No work orders found.</MudText>
                </NoRecordsContent>

                <PagerContent>
                    <MudTablePager />
                </PagerContent>

            </MudTable>

        </div>

    </MudPaper>

</MudContainer>

@code {
    private MudTable<WorkOrder>? _table;
    private string _search = "";

    private Task Reload()
        => _table?.ReloadServerData() ?? Task.CompletedTask;

    private async Task<TableData<WorkOrder>> LoadWorkOrders( TableState state, CancellationToken ct )
    {
        await using var db = await DbFactory.CreateDbContextAsync(ct);

        IQueryable<WorkOrder> q = db.WorkOrders.AsNoTracking();

        if (!string.IsNullOrWhiteSpace(_search))
        {
            var s = _search.Trim();

            q = q.Where(x =>
                (x.ServiceAddress != null && EF.Functions.Like(x.ServiceAddress, $"%{s}%")) ||
                (x.ServiceDetails != null && EF.Functions.Like(x.ServiceDetails, $"%{s}%")) ||
                (x.Status != null && EF.Functions.Like(x.Status, $"%{s}%"))
            );
        }

        q = q.OrderByDescending(x => x.ScheduledServiceDate).ThenByDescending(x => x.Id);

        var total = await q.CountAsync(ct);

        var items = await q
            .Skip(state.Page * state.PageSize)
            .Take(state.PageSize)
            .ToListAsync(ct);

        return new TableData<WorkOrder>
        {
            TotalItems = total,
            Items = items
        };
    }
}
