@page "/login"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Components.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider

@inject NavigationManager Nav
@inject HttpClient Http

<h3>Login</h3>

@if (_error != null)
{
    <div style="color:red">@_error</div>
}

<div>
    <input placeholder="Username" @bind="_username" />
</div>
<div>
    <input placeholder="Password" type="password" @bind="_password" />
</div>

<button @onclick="Submit">Login</button>

@code {
    string _username = "";
    string _password = "";
    string? _error;

    protected override async Task OnInitializedAsync()
    {
        var state = await AuthenticationStateProvider.GetAuthenticationStateAsync();

        if (state.User.Identity?.IsAuthenticated == true)
        {
            Nav.NavigateTo("/", replace: true, forceLoad: true);
        }
    }

    async Task Submit()
    {

        var response = await Http.PostAsJsonAsync(
            "/auth/login",
            new { Username = _username, Password = _password });

        if (!response.IsSuccessStatusCode)
        {
            _error = "Invalid login";
            return;
        }

        // 🔑 FULL PAGE RELOAD so cookie is applied
        Nav.NavigateTo("/", forceLoad: true);
    }
}
