@page "/admin"
@layout AuthLayout
@using Microsoft.AspNetCore.Authorization
@using Microsoft.EntityFrameworkCore
@using CodeBlue.Data
@using CodeBlue.Data.Entities
@inject AppDbContext Db
@inject ISnackbar Snackbar
@inject NavigationManager Nav
@attribute [Authorize]
@* FUTURE: admins only *@
@* @attribute [Authorize(Roles = "Admin")] *@

<PageTitle>Admin Tools</PageTitle>

<MudPaper Class="pa-6" MaxWidth="1200px" Style="margin: 24px auto;">
    <MudStack Spacing="2">
        <MudText Typo="Typo.h4">Admin Tools</MudText>
        <MudText Typo="Typo.body2" Color="Color.Secondary">
            Imports, linking, and maintenance utilities. (Future: admins only)
        </MudText>
    </MudStack>

    <MudDivider Class="my-4" />

    <MudGrid Spacing="3">

        <!-- IMPORTS -->
        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Imports</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.body2">
                            Upload CSV exports and import into tables.
                        </MudText>

                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => Nav.NavigateTo("/admin/import-customers"))">
                                Import Customers
                            </MudButton>

                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => Nav.NavigateTo("/admin/import-workorders"))">
                                Import Work Orders
                            </MudButton>

                            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => Nav.NavigateTo("/admin/import-claims"))">
                                Import Claims
                            </MudButton>
                        </MudStack>

                        <MudAlert Severity="Severity.Info" Variant="Variant.Outlined">
                            Tip: Import Customers first, then Claims. Linking comes after.
                        </MudAlert>
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- LINKING -->
        <MudItem xs="12" md="6">
            <MudCard>
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Linking</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Spacing="2">
                        <MudText Typo="Typo.body2">
                            Attach records together using AddressKey.
                        </MudText>

                        <MudStack Row="true" Spacing="2">
                            <MudButton Variant="Variant.Filled" Color="Color.Secondary" Disabled="@_busy" OnClick="LinkClaimsToCustomers">
                                @(_busy ? "Working..." : "Link Claims → Customers")
                            </MudButton>

                            <MudButton Variant="Variant.Filled" Color="Color.Secondary" Disabled="@_busy" OnClick="LinkWorkOrdersToCustomers">
                                @(_busy ? "Working..." : "Link WorkOrders → Customers")
                            </MudButton>
                        </MudStack>

                        @if (_lastLinkResult is not null)
                        {
                            <MudAlert Severity="Severity.Success" Variant="Variant.Outlined">
                                <MudText Typo="Typo.subtitle2">@_lastLinkResult.Title</MudText>
                                <MudText Typo="Typo.body2">@_lastLinkResult.Summary</MudText>
                            </MudAlert>

                            <MudPaper Class="pa-2" Style="overflow-x:auto;">
                                <MudTable Dense="true" Hover="true" Bordered="true" Items="_lastLinkResult.Rows">
                                    <HeaderContent>
                                        <MudTh>Metric</MudTh>
                                        <MudTh>Count</MudTh>
                                    </HeaderContent>
                                    <RowTemplate>
                                        <MudTd>@context.Metric</MudTd>
                                        <MudTd>@context.Count</MudTd>
                                    </RowTemplate>
                                </MudTable>
                            </MudPaper>

                            @if (_lastLinkResult.UnmatchedExamples.Count > 0)
                            {
                                <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined" Class="mt-3">
                                    <MudText Typo="Typo.subtitle2">Unmatched examples (AddressKey)</MudText>
                                    <MudText Typo="Typo.caption">
                                        @string.Join(", ", _lastLinkResult.UnmatchedExamples)
                                    </MudText>
                                </MudAlert>
                            }
                        }
                    </MudStack>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- STATUS / COUNTS -->
        <MudItem xs="12">
            <MudCard>
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Quick Status</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudStack Row="true" Spacing="2">
                        <MudButton Variant="Variant.Outlined" Disabled="@_busy" OnClick="RefreshCounts">
                            Refresh Counts
                        </MudButton>
                    </MudStack>

                    <MudDivider Class="my-3" />

                    <MudGrid>
                        <MudItem xs="12" sm="4">
                            <MudPaper Class="pa-3">
                                <MudText Typo="Typo.caption">Customers</MudText>
                                <MudText Typo="Typo.h5">@_counts.Customers</MudText>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" sm="4">
                            <MudPaper Class="pa-3">
                                <MudText Typo="Typo.caption">Work Orders</MudText>
                                <MudText Typo="Typo.h5">@_counts.WorkOrders</MudText>
                            </MudPaper>
                        </MudItem>

                        <MudItem xs="12" sm="4">
                            <MudPaper Class="pa-3">
                                <MudText Typo="Typo.caption">Warranty Claims</MudText>
                                <MudText Typo="Typo.h5">@_counts.Claims</MudText>
                            </MudPaper>
                        </MudItem>
                    </MudGrid>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- MAINTENANCE -->
        <MudItem xs="12">
            <MudCard>
                <MudCardHeader>
                    <MudText Typo="Typo.h6">Maintenance</MudText>
                </MudCardHeader>
                <MudCardContent>
                    <MudAlert Severity="Severity.Warning" Variant="Variant.Outlined">
                        Placeholder for future admin-only tools (re-sync jobs, cleanup scripts, duplicate detection, etc).
                    </MudAlert>
                </MudCardContent>
            </MudCard>
        </MudItem>

    </MudGrid>
</MudPaper>

@code {
    private bool _busy = false;

    private Counts _counts = new();
    private LinkResult? _lastLinkResult;

    protected override async Task OnInitializedAsync()
    {
        await RefreshCounts();
    }

    private async Task RefreshCounts()
    {
        _busy = true;
        try
        {
            _counts = new Counts
            {
                Customers = await Db.Customers.CountAsync(),
                WorkOrders = await Db.WorkOrders.CountAsync(),
                Claims = await Db.WarrantyClaims.CountAsync()
            };
        }
        finally
        {
            _busy = false;
        }
    }

    private async Task LinkClaimsToCustomers()
    {
        await RunLink(
            title: "Claims → Customers",
            loadTargets: () => Db.Customers.AsNoTracking()
                .Select(c => new KeyMapRow(c.Id, c.AddressKey))
                .ToListAsync(),
            loadSources: () => Db.WarrantyClaims.Where(x => x.CustomerId == null).ToListAsync(),
            getSourceKey: c => c.AddressKey,
            setSourceFk: ( claim, customerId ) => claim.CustomerId = customerId,
            save: () => Db.SaveChangesAsync()
        );
    }

    private async Task LinkWorkOrdersToCustomers()
    {
        await RunLink(
            title: "WorkOrders → Customers",
            loadTargets: () => Db.Customers.AsNoTracking()
                .Select(c => new KeyMapRow(c.Id, c.AddressKey))
                .ToListAsync(),
            loadSources: () => Db.WorkOrders.Where(x => x.CustomerId == null).ToListAsync(),
            getSourceKey: w => w.AddressKey,
            setSourceFk: ( wo, customerId ) => wo.CustomerId = customerId,
            save: () => Db.SaveChangesAsync()
        );
    }

    private async Task RunLink<TSource>(
        string title,
        Func<Task<List<KeyMapRow>>> loadTargets,
        Func<Task<List<TSource>>> loadSources,
        Func<TSource, string> getSourceKey,
        Action<TSource, Guid> setSourceFk,
        Func<Task<int>> save
    )
    {
        if (_busy)
            return;
        _busy = true;
        _lastLinkResult = null;

        try
        {
            var targets = await loadTargets();
            var customerByKey = new Dictionary<string, Guid>(StringComparer.OrdinalIgnoreCase);

            int targetMissingKey = 0;
            foreach (var t in targets)
            {
                var key = NormalizeAddressKey(t.AddressKey);

                if (string.IsNullOrWhiteSpace(key))
                {
                    targetMissingKey++;
                    continue;
                }

                if (!customerByKey.ContainsKey(key))
                    customerByKey[key] = t.Id;
            }

            var sources = await loadSources();

            int total = sources.Count;
            int sourceMissingKey = 0;
            int linked = 0;
            int notFound = 0;

            var unmatchedExamples = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

            foreach (var s in sources)
            {
                var raw = getSourceKey(s) ?? "";
                var key = NormalizeAddressKey(raw);

                if (string.IsNullOrWhiteSpace(key))
                {
                    sourceMissingKey++;
                    continue;
                }

                if (customerByKey.TryGetValue(key, out var customerId))
                {
                    setSourceFk(s, customerId);
                    linked++;
                }
                else
                {
                    notFound++;
                    if (unmatchedExamples.Count < 12)
                        unmatchedExamples.Add(key);
                }
            }

            if (linked > 0)
                await save();

            _lastLinkResult = new LinkResult
            {
                Title = $"{title} linking complete",
                Summary = $"Processed {total} records that were missing links.",
                Rows = new()
                {
                    new("Processed (missing FK)", total),
                    new("Linked", linked),
                    new("Missing AddressKey", sourceMissingKey),
                    new("No matching Customer", notFound),
                    new("Customers missing AddressKey", targetMissingKey),
                },
                UnmatchedExamples = unmatchedExamples.ToList()
            };

            Snackbar.Add($"{title}: linked {linked}, missing key {sourceMissingKey}, not found {notFound}.", Severity.Success);
            await RefreshCounts();
        }
        catch (Exception ex)
        {
            var msg = ex.InnerException?.Message ?? ex.Message;
            Snackbar.Add($"Linking failed: {msg}", Severity.Error);
        }
        finally
        {
            _busy = false;
        }
    }

    private static string NormalizeAddressKey( string s )
    {
        s = (s ?? "").Trim().ToUpperInvariant();
        if (string.IsNullOrWhiteSpace(s))
            return "";
        return new string(s.Where(char.IsLetterOrDigit).ToArray());
    }

    private sealed record MetricRow( string Metric, int Count );

    private sealed record KeyMapRow( Guid Id, string AddressKey );

    private sealed class LinkResult
    {
        public string Title { get; set; } = "";
        public string Summary { get; set; } = "";
        public List<MetricRow> Rows { get; set; } = new();
        public List<string> UnmatchedExamples { get; set; } = new();
    }

    private sealed class Counts
    {
        public int Customers { get; set; }
        public int WorkOrders { get; set; }
        public int Claims { get; set; }
    }
}
