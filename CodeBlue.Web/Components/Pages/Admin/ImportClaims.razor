@page "/admin/import-claims"
@layout AuthLayout
@using System.Globalization
@using System.Text.RegularExpressions
@using CsvHelper
@using CsvHelper.Configuration
@using Microsoft.AspNetCore.Authorization
@using CodeBlue.Data
@using CodeBlue.Data.Entities
@inject AppDbContext Db
@inject ISnackbar Snackbar

@attribute [Authorize]

<PageTitle>Import Claims</PageTitle>

<MudPaper Class="pa-6" MaxWidth="1200px" Style="margin: 24px auto;">
    <MudText Typo="Typo.h4" GutterBottom>Import Warranty Claims (CSV)</MudText>

    <MudAlert Severity="Severity.Info" Variant="Variant.Outlined" Class="mb-4">
        Imports warranty claims from your Knack export. Address fields are normalized for consistency, and
        <b>AddressKey</b> is used (or generated from Street 1) for future linking.
    </MudAlert>

    <MudStepper linear="true" @bind-ActiveIndex="_step">

        <!-- STEP 1: UPLOAD -->
        <MudStep label="Upload">
            <MudStack Spacing="2">
                <MudFileUpload T="IBrowserFile" FilesChanged="OnFileChanged">
                    <ActivatorContent>
                        <MudButton Variant="Variant.Filled" Color="Color.Primary">
                            Choose CSV File
                        </MudButton>
                    </ActivatorContent>
                </MudFileUpload>

                @if (!string.IsNullOrWhiteSpace(_fileName))
                {
                    <MudText Typo="Typo.caption">
                        Loaded: @_fileName (@_rows.Count rows read)
                    </MudText>
                }
            </MudStack>
        </MudStep>

        <!-- STEP 2: MAP -->
        <MudStep label="Map Fields" Disabled="@(!_headers.Any())">
            <MudText Typo="Typo.body2" Class="mb-3">
                Map CSV columns to Claim fields. Choose <i>(ignore)</i> to skip.
                <br />
                <b>Tip:</b> Map <b>Claim Number</b> and <b>AddressKey</b>. If AddressKey is missing, we’ll generate it from Street 1.
            </MudText>

            <MudGrid>
                @foreach (var key in _mappingKeys)
                {
                    <MudItem xs="12" sm="6">
                        <MudSelect T="string" Label="@key" @bind-Value="_mappings[key]">
                            <MudSelectItem T="string" Value="@IgnoreValue">(ignore)</MudSelectItem>
                            @foreach (var h in _headers)
                            {
                                <MudSelectItem T="string" Value="@h">@h</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                }
            </MudGrid>

            <MudDivider Class="my-4" />

            <MudStack Row="true" Spacing="2">
                <MudButton Variant="Variant.Outlined" OnClick="BuildPreview">Refresh Preview</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="@(() => _step = 2)">Next</MudButton>
            </MudStack>
        </MudStep>

        <!-- STEP 3: PREVIEW / IMPORT -->
        <MudStep label="Preview & Import" Disabled="@(!_rows.Any())">
            <MudText Typo="Typo.body2" Class="mb-2">
                Previewing first 25 rows. Rows without <b>Claim Number</b> are skipped.
            </MudText>

            <MudPaper Class="pa-2" Style="overflow-x:auto;">
                <MudTable Items="_preview" Dense="true" Hover="true" Bordered="true">
                    <HeaderContent>
                        <MudTh Style="min-width:120px;">Claim #</MudTh>
                        <MudTh Style="min-width:320px;">Address</MudTh>
                        <MudTh Style="min-width:240px;">Street 1 (cleaned)</MudTh>
                        <MudTh Style="min-width:180px;">City</MudTh>
                        <MudTh Style="min-width:90px;">State</MudTh>
                        <MudTh Style="min-width:120px;">Zip</MudTh>

                        <MudTh Style="min-width:180px;">Installer/Dealer</MudTh>
                        <MudTh Style="min-width:160px;">Install Date</MudTh>

                        <MudTh Style="min-width:140px;">Component Code</MudTh>
                        <MudTh Style="min-width:200px;">ID/Serial #</MudTh>
                        <MudTh Style="min-width:200px;">Component Serial #</MudTh>

                        <MudTh Style="min-width:180px;">Model #</MudTh>
                        <MudTh Style="min-width:160px;">Failure Date</MudTh>
                        <MudTh Style="min-width:160px;">Repair Date</MudTh>
                        <MudTh Style="min-width:120px;">Status</MudTh>

                        <MudTh Style="min-width:200px;">AddressKey</MudTh>
                        <MudTh Style="min-width:140px;">Lat</MudTh>
                        <MudTh Style="min-width:140px;">Lng</MudTh>

                        <MudTh Style="min-width:220px;">Image1 URL</MudTh>
                        <MudTh Style="min-width:220px;">Image2 URL</MudTh>

                        <MudTh Style="min-width:180px;">Completed By</MudTh>
                        <MudTh Style="min-width:180px;">Knack Record ID</MudTh>
                    </HeaderContent>

                    <RowTemplate>
                        <MudTd>@context.ClaimNumber</MudTd>
                        <MudTd>@context.Address</MudTd>
                        <MudTd>@context.Street1</MudTd>
                        <MudTd>@context.City</MudTd>
                        <MudTd>@context.State</MudTd>
                        <MudTd>@context.Zip</MudTd>

                        <MudTd>@context.OriginalInstallerDealer</MudTd>
                        <MudTd>@(context.OriginalInstallationDate?.ToString() ?? "")</MudTd>

                        <MudTd>@context.ComponentCode</MudTd>
                        <MudTd>@context.IdSerialNumber</MudTd>
                        <MudTd>@context.ComponentSerialNumber</MudTd>

                        <MudTd>@context.ModelNumber</MudTd>
                        <MudTd>@(context.FailureDate?.ToString() ?? "")</MudTd>
                        <MudTd>@(context.RepairDate?.ToString() ?? "")</MudTd>
                        <MudTd>@context.Status</MudTd>

                        <MudTd>@context.AddressKey</MudTd>
                        <MudTd>@(context.Latitude?.ToString() ?? "")</MudTd>
                        <MudTd>@(context.Longitude?.ToString() ?? "")</MudTd>

                        <MudTd>@context.Image1Url</MudTd>
                        <MudTd>@context.Image2Url</MudTd>

                        <MudTd>@context.CompletedBy</MudTd>
                        <MudTd>@context.LegacyRecordId</MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>

            <MudDivider Class="my-4" />

            <MudStack Row="true" Justify="Justify.FlexEnd" Spacing="2">
                <MudButton Variant="Variant.Outlined" OnClick="Reset">Reset</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Disabled="@_isBusy" OnClick="Import">
                    @(_isBusy ? "Importing..." : "Import")
                </MudButton>
            </MudStack>
        </MudStep>

    </MudStepper>
</MudPaper>

@code {
    private const string IgnoreValue = "__IGNORE__";

    private int _step = 0;
    private bool _isBusy = false;

    private string _fileName = "";
    private readonly List<string> _headers = new();
    private readonly List<Dictionary<string, string>> _rows = new();

    private readonly List<string> _mappingKeys = new()
    {
        "ClaimNumber",
        "Address",
        "Street1",
        "Street2",
        "City",
        "State",
        "Zip",
        "Country",
        "Latitude",
        "Longitude",

        "LegacyRecordId",
        "OriginalInstallerDealer",
        "OriginalInstallationDate",

        "ComponentCode",
        "IdSerialNumber",
        "ComponentSerialNumber",

        "AddressKey",
        "ServiceRequest",

        "Image1",
        "Image1Url",
        "Image2",
        "Image2Url",

        "CompletedBy",
        "ModelNumber",
        "FailureDate",
        "RepairDate",
        "Status"
    };

    private readonly Dictionary<string, string> _mappings = new()
    {
        ["ClaimNumber"] = "Claim Number",
        ["Address"] = "Address",
        ["Street1"] = "Address : Street 1",
        ["Street2"] = "Address : Street 2",
        ["City"] = "Address : City",
        ["State"] = "Address : State",
        ["Zip"] = "Address : Zip",
        ["Country"] = "Address : Country",
        ["Latitude"] = "Address : Latitude",
        ["Longitude"] = "Address : Longitude",

        ["LegacyRecordId"] = "Record ID",
        ["OriginalInstallerDealer"] = "Original Installer/Dealer",
        ["OriginalInstallationDate"] = "Original Installation Date",

        ["ComponentCode"] = "Component Code",
        ["IdSerialNumber"] = "ID/Serial #",
        ["ComponentSerialNumber"] = "Component Serial #",

        ["AddressKey"] = "AddressKey",
        ["ServiceRequest"] = "Service Request",

        ["Image1"] = "Image 1",
        ["Image1Url"] = "Image 1 : URL",
        ["Image2"] = "Image 2",
        ["Image2Url"] = "Image 2 : URL",

        ["CompletedBy"] = "Completed By",
        ["ModelNumber"] = "Model #",
        ["FailureDate"] = "Failure Date",
        ["RepairDate"] = "Repair Date",
        ["Status"] = "Status"
    };

    private List<ClaimPreviewRow> _preview = new();

    private async Task OnFileChanged( IBrowserFile file )
    {
        Reset();
        _fileName = file.Name;

        using var stream = file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024);
        using var reader = new StreamReader(stream);

        var config = new CsvConfiguration(CultureInfo.InvariantCulture)
        {
            BadDataFound = null,
            MissingFieldFound = null,
            HeaderValidated = null,
            DetectDelimiter = true
        };

        using var csv = new CsvReader(reader, config);

        if (!await csv.ReadAsync() || !csv.ReadHeader())
        {
            Snackbar.Add("Could not read CSV header row.", Severity.Error);
            return;
        }

        _headers.AddRange(csv.HeaderRecord ?? Array.Empty<string>());

        foreach (var key in _mappingKeys)
        {
            if (!_mappings.ContainsKey(key))
                _mappings[key] = IgnoreValue;

            if (_mappings[key] != IgnoreValue && !_headers.Contains(_mappings[key]))
                _mappings[key] = IgnoreValue;
        }

        while (await csv.ReadAsync() && _rows.Count < 20000)
        {
            var dict = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);
            foreach (var h in _headers)
                dict[h] = csv.GetField(h) ?? "";
            _rows.Add(dict);
        }

        BuildPreview();
        _step = 1;
    }

    private void BuildPreview()
    {
        _preview = _rows
            .Select(MapRowToPreview)
            .Where(r => !string.IsNullOrWhiteSpace(r.ClaimNumber))
            .Take(25)
            .ToList();

        StateHasChanged();
    }

    private ClaimPreviewRow MapRowToPreview( Dictionary<string, string> row )
    {
        string Get( string key )
        {
            if (!_mappings.TryGetValue(key, out var header))
                return "";
            if (string.IsNullOrWhiteSpace(header) || header == IgnoreValue)
                return "";
            return row.TryGetValue(header, out var v) ? (v ?? "") : "";
        }

        static DateOnly? ParseDate( string s )
        {
            if (string.IsNullOrWhiteSpace(s))
                return null;
            if (DateTime.TryParse(s, out var dt))
                return DateOnly.FromDateTime(dt);
            return null;
        }

        static decimal? ParseDecimal( string s )
        {
            if (string.IsNullOrWhiteSpace(s))
                return null;
            if (decimal.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out var d))
                return d;
            if (decimal.TryParse(s, NumberStyles.Any, CultureInfo.CurrentCulture, out d))
                return d;
            return null;
        }

        var street1 = NormalizeStreet(Get("Street1"));
        var street2 = NormalizeStreet(Get("Street2"));

        var city = NormalizeCityState(Get("City"));
        var state = NormalizeCityState(Get("State"));
        var zip = NormalizeZip(Get("Zip"));

        var addrFromCsv = NormalizeText(Get("Address"));
        var displayAddress = !string.IsNullOrWhiteSpace(addrFromCsv)
            ? addrFromCsv
            : BuildDisplayAddress(street1, street2, city, state, zip);

        var addressKeyFromCsv = NormalizeAddressKey(Get("AddressKey"));
        var generatedAddressKey = GenerateAddressKeyFromStreet1(street1);

        return new ClaimPreviewRow
        {
            ClaimNumber = NormalizeText(Get("ClaimNumber")),
            Address = displayAddress,

            Street1 = street1,
            Street2 = NullIfEmpty(street2),
            City = city,
            State = state,
            Zip = zip,
            Country = NullIfEmpty(NormalizeText(Get("Country"))),

            Latitude = ParseDecimal(Get("Latitude")),
            Longitude = ParseDecimal(Get("Longitude")),

            LegacyRecordId = NullIfEmpty(NormalizeText(Get("LegacyRecordId"))),
            OriginalInstallerDealer = NullIfEmpty(NormalizeText(Get("OriginalInstallerDealer"))),
            OriginalInstallationDate = ParseDate(Get("OriginalInstallationDate")),

            ComponentCode = NullIfEmpty(NormalizeText(Get("ComponentCode"))),
            IdSerialNumber = NullIfEmpty(NormalizeText(Get("IdSerialNumber"))),
            ComponentSerialNumber = NullIfEmpty(NormalizeText(Get("ComponentSerialNumber"))),

            AddressKey = !string.IsNullOrWhiteSpace(addressKeyFromCsv) ? addressKeyFromCsv : generatedAddressKey,
            ServiceRequest = NullIfEmpty(NormalizeText(Get("ServiceRequest"))),

            Image1 = NullIfEmpty(NormalizeText(Get("Image1"))),
            Image1Url = NullIfEmpty(NormalizeText(Get("Image1Url"))),
            Image2 = NullIfEmpty(NormalizeText(Get("Image2"))),
            Image2Url = NullIfEmpty(NormalizeText(Get("Image2Url"))),

            CompletedBy = NullIfEmpty(NormalizeText(Get("CompletedBy"))),
            ModelNumber = NullIfEmpty(NormalizeText(Get("ModelNumber"))),
            FailureDate = ParseDate(Get("FailureDate")),
            RepairDate = ParseDate(Get("RepairDate")),
            Status = NullIfEmpty(NormalizeText(Get("Status")))
        };
    }

    private async Task Import()
    {
        if (_isBusy)
            return;
        _isBusy = true;

        try
        {
            var claims = _rows
                .Select(MapRowToPreview)
                .Where(p => !string.IsNullOrWhiteSpace(p.ClaimNumber))
                .Select(p => new WarrantyClaim
                {
                    Id = Guid.NewGuid(),

                    ClaimNumber = p.ClaimNumber,
                    Address = p.Address,

                    Street1 = p.Street1,
                    Street2 = p.Street2,
                    City = p.City,
                    State = p.State,
                    Zip = p.Zip,
                    Country = p.Country,

                    Latitude = p.Latitude,
                    Longitude = p.Longitude,

                    LegacyRecordId = p.LegacyRecordId,
                    OriginalInstallerDealer = p.OriginalInstallerDealer,
                    OriginalInstallationDate = p.OriginalInstallationDate,

                    ComponentCode = p.ComponentCode,
                    IdSerialNumber = p.IdSerialNumber,
                    ComponentSerialNumber = p.ComponentSerialNumber,

                    AddressKey = p.AddressKey,
                    ServiceRequest = p.ServiceRequest,

                    Image1 = p.Image1,
                    Image1Url = p.Image1Url,
                    Image2 = p.Image2,
                    Image2Url = p.Image2Url,

                    CompletedBy = p.CompletedBy,
                    ModelNumber = p.ModelNumber,
                    FailureDate = p.FailureDate,
                    RepairDate = p.RepairDate,
                    Status = p.Status

                    // CustomerId / WorkOrderId are linked later via AddressKey / workflow
                })
                // avoid duplicates inside incoming file by ClaimNumber
                .GroupBy(c => c.ClaimNumber, StringComparer.OrdinalIgnoreCase)
                .Select(g => g.First())
                .ToList();

            if (claims.Count == 0)
            {
                Snackbar.Add("No valid rows found (Claim Number is required).", Severity.Warning);
                return;
            }

            Db.WarrantyClaims.AddRange(claims);
            await Db.SaveChangesAsync();

            Snackbar.Add($"Imported {claims.Count} claims.", Severity.Success);
            Reset();
        }
        catch (Exception ex)
        {
            var msg = ex.InnerException?.Message ?? ex.Message;
            Snackbar.Add($"Import failed: {msg}", Severity.Error);
        }
        finally
        {
            _isBusy = false;
        }
    }

    private void Reset()
    {
        _step = 0;
        _isBusy = false;
        _fileName = "";
        _headers.Clear();
        _rows.Clear();
        _preview = new();
        StateHasChanged();
    }

    // -------------------------
    // Normalization helpers
    // -------------------------

    private static string NormalizeStreet( string s )
    {
        s = (s ?? "").Trim();
        if (string.IsNullOrWhiteSpace(s))
            return "";

        s = s.Replace(".", " ").Replace(",", " ").Replace(";", " ").Replace(":", " ");
        s = Regex.Replace(s, @"^(\d+)([A-Za-z])", "$1 $2");
        s = Regex.Replace(s, @"\s+", " ").Trim();

        return s.ToUpperInvariant();
    }

    private static string NormalizeCityState( string s )
    {
        s = (s ?? "").Trim();
        if (string.IsNullOrWhiteSpace(s))
            return "";
        s = Regex.Replace(s, @"\s+", " ").Trim();
        return s.ToUpperInvariant();
    }

    private static string NormalizeZip( string s )
    {
        s = (s ?? "").Trim();
        if (string.IsNullOrWhiteSpace(s))
            return "";
        return new string(s.Where(c => char.IsDigit(c) || c == '-').ToArray());
    }

    private static string NormalizeText( string s )
    {
        s = (s ?? "").Trim();
        if (string.IsNullOrWhiteSpace(s))
            return "";
        return Regex.Replace(s, @"\s+", " ").Trim();
    }

    private static string BuildDisplayAddress( string street1, string street2, string city, string state, string zip )
    {
        var line1 = street1;
        if (!string.IsNullOrWhiteSpace(street2))
            line1 = $"{line1} {street2}".Trim();

        var line2 = "";
        if (!string.IsNullOrWhiteSpace(city))
            line2 += city;
        if (!string.IsNullOrWhiteSpace(state))
        {
            if (line2.Length > 0)
                line2 += ", ";
            line2 += state;
        }
        if (!string.IsNullOrWhiteSpace(zip))
        {
            if (line2.Length > 0)
                line2 += " ";
            line2 += zip;
        }

        if (string.IsNullOrWhiteSpace(line2))
            return line1.Trim();

        return $"{line1.Trim()}, {line2.Trim()}";
    }

    private static string NormalizeAddressKey( string s )
    {
        s = (s ?? "").Trim().ToUpperInvariant();
        if (string.IsNullOrWhiteSpace(s))
            return "";
        return new string(s.Where(char.IsLetterOrDigit).ToArray());
    }

    private static string GenerateAddressKeyFromStreet1( string street1 )
    {
        if (string.IsNullOrWhiteSpace(street1))
            return "";
        return new string(street1.ToUpperInvariant().Where(char.IsLetterOrDigit).ToArray());
    }

    private static string? NullIfEmpty( string s )
        => string.IsNullOrWhiteSpace(s) ? null : s;

    private sealed class ClaimPreviewRow
    {
        public string ClaimNumber { get; set; } = "";
        public string Address { get; set; } = "";

        public string Street1 { get; set; } = "";
        public string? Street2 { get; set; }
        public string City { get; set; } = "";
        public string State { get; set; } = "";
        public string Zip { get; set; } = "";
        public string? Country { get; set; }

        public decimal? Latitude { get; set; }
        public decimal? Longitude { get; set; }

        public string? LegacyRecordId { get; set; }
        public string? OriginalInstallerDealer { get; set; }
        public DateOnly? OriginalInstallationDate { get; set; }

        public string? ComponentCode { get; set; }
        public string? IdSerialNumber { get; set; }
        public string? ComponentSerialNumber { get; set; }

        public string AddressKey { get; set; } = "";
        public string? ServiceRequest { get; set; }

        public string? Image1 { get; set; }
        public string? Image1Url { get; set; }
        public string? Image2 { get; set; }
        public string? Image2Url { get; set; }

        public string? CompletedBy { get; set; }
        public string? ModelNumber { get; set; }
        public DateOnly? FailureDate { get; set; }
        public DateOnly? RepairDate { get; set; }
        public string? Status { get; set; }
    }
}
